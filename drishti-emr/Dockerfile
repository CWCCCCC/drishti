#FROM tomcat:7-jre8
#
## Docker configuration automatically generated by openmrs SDK
#
#COPY openmrs.war  /usr/local/tomcat/webapps/openmrs.war
#COPY modules /usr/local/tomcat/.OpenMRS/modules
#COPY owa /usr/local/tomcat/.OpenMRS/owa
#
#COPY openmrs-runtime.properties /usr/local/tomcat/openmrs-runtime.properties
#
#
#COPY setenv.sh /usr/local/tomcat/bin/setenv.sh
#
#COPY wait-for-it.sh /usr/local/tomcat/wait-for-it.sh
#COPY startup.sh /usr/local/tomcat/startup.sh
#
#RUN sed -i '/Connector port="8080"/a URIEncoding="UTF-8" relaxedPathChars="[]|" relaxedQueryChars="[]|{}^&#x5c;&#x60;&quot;&lt;&gt;"' /usr/local/tomcat/conf/server.xml
#
#RUN chmod +x /usr/local/tomcat/wait-for-it.sh
#RUN chmod +x /usr/local/tomcat/startup.sh
#
## For documentation purpose only
#COPY openmrs-distro.properties /root/openmrs-distro.properties
#COPY Dockerfile /root/Dockerfile
#
#CMD ["/usr/local/tomcat/startup.sh"]

FROM alpine:3.3

MAINTAINER Pascal Brandt <pascal@openmrs.org>

ENV TOMCAT_MAJOR=7 \
    TOMCAT_VERSION=7.0.69 \
    TOMCAT_HOME=/etc/tomcat \
    CATALINA_HOME=/etc/tomcat \
    OPENMRS_HOME=/root/.OpenMRS

RUN apk add --update openjdk8 curl; \
    curl -L http://archive.apache.org/dist/tomcat/tomcat-${TOMCAT_MAJOR}/v${TOMCAT_VERSION}/bin/apache-tomcat-${TOMCAT_VERSION}.tar.gz \
      -o /tmp/apache-tomcat-${TOMCAT_VERSION}.tar.gz; \
    tar -zxvf /tmp/apache-tomcat-${TOMCAT_VERSION}.tar.gz -C /etc; \
    ln -s /etc/apache-tomcat-${TOMCAT_VERSION} ${TOMCAT_HOME}; \
    rm -f /tmp/apache-tomcat-${TOMCAT_VERSION}.tar.gz; \
    rm -rf ${TOMCAT_HOME}/webapps/*; \
    curl -L https://bintray.com/psbrandt/generic/download_file?file_path=openmrs-1.11.5.war \
      -o ${TOMCAT_HOME}/webapps/openmrs.war; \
    curl -L https://bintray.com/psbrandt/generic/download_file?file_path=openmrs-2.3.1-modules.tgz \
      -o /tmp/openmrs-2.3.1-modules.tgz; \
    mkdir -p ${OPENMRS_HOME}/modules; \
    mkdir -p ${OPENMRS_HOME}/owa; \

    tar -zxvf /tmp/openmrs-2.3.1-modules.tgz -C ${OPENMRS_HOME}/modules; \
    rm -f /tmp/openmrs-2.3.1-modules.tgz; \
    apk del curl && rm -f /var/cache/apk/*

COPY drishti-1.0.0-SNAPSHOT.omod ${OPENMRS_HOME}/modules/drishti-1.0.0-SNAPSHOT.omod
COPY owa-1.10.0.omod ${OPENMRS_HOME}/modules/owa-1.10.0.omod
COPY drishti ${OPENMRS_HOME}/owa/drishti
#COPY web/openmrs.war ${TOMCAT_HOME}/webapps/openmrs.war
#COPY web/modules ${TOMCAT_HOME}/modules
#COPY web/owa ${TOMCAT_HOME}/owa

COPY openmrs-runtime.properties ${OPENMRS_HOME}/openmrs-runtime.properties
#COPY openmrs-server.properties ${OPENMRS_HOME}/openmrs-server.properties
COPY setenv.sh ${TOMCAT_HOME}/bin/setenv.sh

EXPOSE 8080

CMD ${TOMCAT_HOME}/bin/catalina.sh run
